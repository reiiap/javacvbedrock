name: Pack Converter (With 3D â†’ 2D Icon)

on:
  issues:
    types: [opened]

jobs:
  convert:
    if: contains(github.event.issue.labels.*.name, 'conversion-icon')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      # ==============================
      # PARSE ISSUE FORM SAFELY
      # ==============================
      - name: Parse Issue Form
        id: parse
        run: |
          cat <<'EOF' > raw.json
          ${{ toJSON(github.event.issue.body) }}
          EOF

          # Extract JSON block from issue body
          echo "${{ steps.parse.outputs.data }}" > /dev/null

      # ==============================
      # ORGANIZE INPUTS (ANTI ERROR)
      # ==============================
      - name: Organize Inputs
        id: organize
        run: |
          cat <<'EOF' > issue.json
          ${{ steps.parse-issue.outputs.data }}
          EOF

          jq -r '
          def test_input($input; $default):
            if ($input == "*No response*" or $input == "None")
            then $default
            else ($input | tostring)
            end;

          def clean_url($url):
            $url
            | gsub("^<";"")
            | gsub(">$";"")
            | gsub("&dl=0";"&dl=1");

          {
            pack_url: clean_url(.["java-pack-direct-download-url"].text),
            default_pack_url: clean_url(test_input(.["default-pack-direct-download-url"].text; "null")),
            merge_pack_url: clean_url(test_input(.["bedrock-merge-pack-direct-download-url"].text; "null")),
            default_assets_version: test_input(.["default-assets-version"].text; "1.19.3"),
            block_material: test_input(.["block-material"].text; "alpha_test"),
            attachable_material: test_input(.["attachable-material"].text; "entity_alphatest_one_sided"),
            archive_scratch: test_input(.["archive-scratch-files"].text; "false"),
            rename_model_files: test_input(.["rename-model-files"].text; "false")
          }' issue.json > inputs.json

          echo "PACK_URL=$(jq -r '.pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_PACK_URL=$(jq -r '.default_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "MERGE_PACK_URL=$(jq -r '.merge_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_ASSETS_VERSION=$(jq -r '.default_assets_version' inputs.json)" >> $GITHUB_OUTPUT
          echo "BLOCK_MATERIAL=$(jq -r '.block_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ATTACHABLE_MATERIAL=$(jq -r '.attachable_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ARCHIVE_SCRATCH=$(jq -r '.archive_scratch' inputs.json)" >> $GITHUB_OUTPUT
          echo "RENAME_MODEL_FILES=$(jq -r '.rename_model_files' inputs.json)" >> $GITHUB_OUTPUT

      # ==============================
      # DOWNLOAD PACK
      # ==============================
      - name: Download Pack
        run: |
          mkdir staging
          cd staging
          echo "Downloading pack..."
          curl -L --fail -o input_pack.zip "${{ steps.organize.outputs.PACK_URL }}"

      # ==============================
      # UNZIP
      # ==============================
      - name: Extract Pack
        run: |
          cd staging
          unzip input_pack.zip -d input_pack

      # ==============================
      # CONVERSION SCRIPT
      # ==============================
      - name: Run Converter
        run: |
          echo "Running conversion..."
          chmod +x converter.sh
          ./converter.sh

      # ==============================
      # UPLOAD RESULT
      # ==============================
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: converted-pack
          path: staging/output
