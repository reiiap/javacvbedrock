name: Conversion Request with icon

on:
  issues:
    types:
      - labeled

jobs:
  get-pack-info:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'conversion-icon'
    permissions:
      issues: read
    timeout-minutes: 2
    outputs:
      pack_url: ${{ steps.organize-inputs.outputs.PACK_URL }}
      default_pack_url: ${{ steps.organize-inputs.outputs.DEFAULT_PACK_URL }}
      merge_pack_url: ${{ steps.organize-inputs.outputs.MERGE_PACK_URL }}
      default_assets_version: ${{ steps.organize-inputs.outputs.DEFAULT_ASSETS_VERSION }}
      block_material: ${{ steps.organize-inputs.outputs.BLOCK_MATERIAL }}
      attachable_material: ${{ steps.organize-inputs.outputs.ATTACHABLE_MATERIAL }}
      archive_scratch: ${{ steps.organize-inputs.outputs.ARCHIVE_SCRATCH }}
      rename_model_files: ${{ steps.organize-inputs.outputs.RENAME_MODEL_FILES }}

    steps:
      - name: Issue Forms Body Parser
        id: parse-issue
        uses: zentered/issue-forms-body-parser@v1.5.1

      - name: Organize Inputs
        id: organize-inputs
        run: |
          printf '%s' "${{ toJSON(steps.parse-issue.outputs.data) }}" | jq '
          def test_input($input; $default):
            if ($input == "*No response*" or $input == "None")
            then $default
            else ($input | tostring | gsub("\\\\";""))
            end;

          def clean_url($url):
            $url
            | gsub("^<";"")
            | gsub(">$";"")
            | gsub("&dl=0";"&dl=1");

          {
            "pack_url": clean_url(.["java-pack-direct-download-url"].text),
            "default_pack_url": clean_url(test_input(.["default-pack-direct-download-url"].text; "null")),
            "merge_pack_url": clean_url(test_input(.["bedrock-merge-pack-direct-download-url"].text; "null")),
            "default_assets_version": test_input(.["default-assets-version"].text; "1.19.3"),
            "block_material": test_input(.["block-material"].text; "alpha_test"),
            "attachable_material": test_input(.["attachable-material"].text; "entity_alphatest_one_sided"),
            "archive_scratch": test_input(.["archive-scratch-files"].text; "false"),
            "rename_model_files": test_input(.["rename-model-files"].text; "false")
          }' > inputs.json

          echo "PACK_URL=$(jq -r '.pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_PACK_URL=$(jq -r '.default_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "MERGE_PACK_URL=$(jq -r '.merge_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_ASSETS_VERSION=$(jq -r '.default_assets_version' inputs.json)" >> $GITHUB_OUTPUT
          echo "BLOCK_MATERIAL=$(jq -r '.block_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ATTACHABLE_MATERIAL=$(jq -r '.attachable_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ARCHIVE_SCRATCH=$(jq -r '.archive_scratch' inputs.json)" >> $GITHUB_OUTPUT
          echo "RENAME_MODEL_FILES=$(jq -r '.rename_model_files' inputs.json)" >> $GITHUB_OUTPUT


  convert-pack:
    runs-on: ubuntu-latest
    needs: get-pack-info
    permissions:
      contents: read
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Update APT
        run: |
          sudo apt-get clean
          sudo apt-get update

      - name: Install Dependencies
        run: |
          sudo apt-get install -y zip unzip jq imagemagick ghostscript
          npm install -g minecraft-item-renderer

      - name: Download Pack
        run: |
          mkdir staging
          cd staging
          echo "Downloading pack..."
          curl -L --fail -o input_pack.zip "${{ needs.get-pack-info.outputs.pack_url }}"

      - name: Convert 3D Models to 2D Icons
        run: |
          cd staging
          unzip -o input_pack.zip -d java_pack

          mkdir -p java_pack/generated_icons

          if [ -d "java_pack/assets/minecraft/models/item" ]; then
            for model in java_pack/assets/minecraft/models/item/*.json; do
              filename=$(basename "$model" .json)
              echo "Rendering $filename..."
              minecraft-item-renderer \
                --model "$model" \
                --output "java_pack/generated_icons/${filename}.png" \
                --size 64 || true
            done
          fi

          mkdir -p java_pack/assets/minecraft/textures/items
          cp java_pack/generated_icons/*.png java_pack/assets/minecraft/textures/items/ 2>/dev/null || true

          cd java_pack
          zip -r ../input_pack.zip .
          cd ..

      - name: Run Converter
        run: |
          cd staging
          cp ../converter.sh .
          chmod +x converter.sh

          ./converter.sh input_pack.zip \
            -w "false" \
            -m "${{ needs.get-pack-info.outputs.merge_pack_url }}" \
            -a "${{ needs.get-pack-info.outputs.attachable_material }}" \
            -b "${{ needs.get-pack-info.outputs.block_material }}" \
            -f "${{ needs.get-pack-info.outputs.default_pack_url }}" \
            -v "${{ needs.get-pack-info.outputs.default_assets_version }}" \
            -r "${{ needs.get-pack-info.outputs.rename_model_files }}" \
            -s "${{ needs.get-pack-info.outputs.archive_scratch }}" \
            -u "true"

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Pack Files
          path: |
            staging/target/packaged/geyser_resources.mcpack
            staging/target/packaged/geyser_addon.mcaddon
            staging/target/geyser_mappings.json
            staging/target/scratch_files.zip
            staging/config.json


  post-result:
    runs-on: ubuntu-latest
    needs: convert-pack
    permissions:
      issues: write

    steps:
      - name: Comment Success
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üöÄ Conversion with Icon Completed!

            ‚úî Java 3D models converted into 2D Bedrock icons  
            ‚úî Pack converted successfully  

            Download here:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Close Issue
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}


  conversion-failed:
    runs-on: ubuntu-latest
    needs: [get-pack-info, convert-pack]
    if: failure()
    permissions:
      issues: write

    steps:
      - name: Comment Failure
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚ùå Conversion with icon failed.

            Check logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Close Issue
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}
