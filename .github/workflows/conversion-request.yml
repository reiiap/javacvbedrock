name: ReiiAp - Conversion Request

on:
  issues:
    types:
      - labeled

jobs:
  get-pack-info:
    name: üì• Ambil Data Pack
    runs-on: ubuntu-latest
    if: github.event.label.name == 'conversion'
    permissions:
      issues: read
    timeout-minutes: 2
    outputs:
      pack_url: ${{ steps.organize.outputs.PACK_URL }}
      default_pack_url: ${{ steps.organize.outputs.DEFAULT_PACK_URL }}
      merge_pack_url: ${{ steps.organize.outputs.MERGE_PACK_URL }}
      default_assets_version: ${{ steps.organize.outputs.DEFAULT_ASSETS_VERSION }}
      block_material: ${{ steps.organize.outputs.BLOCK_MATERIAL }}
      attachable_material: ${{ steps.organize.outputs.ATTACHABLE_MATERIAL }}
      archive_scratch: ${{ steps.organize.outputs.ARCHIVE_SCRATCH }}
      rename_model_files: ${{ steps.organize.outputs.RENAME_MODEL_FILES }}

    steps:
      - name: Parse Issue Form
        id: parse
        uses: zentered/issue-forms-body-parser@v1.5.1

      - name: Organize Inputs
        id: organize
        run: |
          echo ${{ toJSON(steps.parse.outputs.data) }} | jq '
          def test_input($input; $default):
          if ($input == "*No response*" or $input == "None") then $default else ($input | tostring | gsub("\\\\";""))  end;
          {
            "pack_url": .["java-pack-direct-download-url"].text[1:-1],
            "default_pack_url": test_input(.["default-pack-direct-download-url"].text; "null")[1:-1],
            "merge_pack_url": test_input(.["bedrock-merge-pack-direct-download-url"].text; "null")[1:-1],
            "default_assets_version": test_input(.["default-assets-version"].text; "1.19.3"),
            "block_material": test_input(.["block-material"].text; "alpha_test"),
            "attachable_material": test_input(.["attachable-material"].text; "entity_alphatest_one_sided"),
            "archive_scratch": test_input(.["archive-scratch-files"].text; "false"),
            "rename_model_files": test_input(.["rename-model-files"].text; "false")
          }' > inputs.json

          echo "PACK_URL=$(jq -r '.pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_PACK_URL=$(jq -r '.default_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "MERGE_PACK_URL=$(jq -r '.merge_pack_url' inputs.json)" >> $GITHUB_OUTPUT
          echo "DEFAULT_ASSETS_VERSION=$(jq -r '.default_assets_version' inputs.json)" >> $GITHUB_OUTPUT
          echo "BLOCK_MATERIAL=$(jq -r '.block_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ATTACHABLE_MATERIAL=$(jq -r '.attachable_material' inputs.json)" >> $GITHUB_OUTPUT
          echo "ARCHIVE_SCRATCH=$(jq -r '.archive_scratch' inputs.json)" >> $GITHUB_OUTPUT
          echo "RENAME_MODEL_FILES=$(jq -r '.rename_model_files' inputs.json)" >> $GITHUB_OUTPUT


  convert-pack:
    name: üîÑ Convert Resource Pack
    runs-on: ubuntu-latest
    needs: get-pack-info
    permissions:
      contents: read
    timeout-minutes: 90

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y moreutils zip imagemagick ghostscript
          npm install -g spritesheet-js

      - name: Run Converter
        env:
          PACK_URL: ${{ needs.get-pack-info.outputs.pack_url }}
          DEFAULT_PACK_URL: ${{ needs.get-pack-info.outputs.default_pack_url }}
          MERGE_PACK_URL: ${{ needs.get-pack-info.outputs.merge_pack_url }}
          DEFAULT_ASSETS_VERSION: ${{ needs.get-pack-info.outputs.default_assets_version }}
          BLOCK_MATERIAL: ${{ needs.get-pack-info.outputs.block_material }}
          ATTACHABLE_MATERIAL: ${{ needs.get-pack-info.outputs.attachable_material }}
          ARCHIVE_SCRATCH: ${{ needs.get-pack-info.outputs.archive_scratch }}
          RENAME_MODEL_FILES: ${{ needs.get-pack-info.outputs.rename_model_files }}
        run: |
          mkdir staging
          cp converter.sh staging/
          cd staging
          chmod +x converter.sh

          curl -L -o input_pack.zip "${PACK_URL}"

          if [ "${MERGE_PACK_URL}" != "null" ]; then
            curl -L -o merge_pack.zip "${MERGE_PACK_URL}"
            MERGE="merge_pack.zip"
          else
            MERGE="null"
          fi

          ./converter.sh input_pack.zip \
            -w "false" \
            -m ${MERGE} \
            -a ${ATTACHABLE_MATERIAL} \
            -b ${BLOCK_MATERIAL} \
            -f ${DEFAULT_PACK_URL} \
            -v ${DEFAULT_ASSETS_VERSION} \
            -r ${RENAME_MODEL_FILES} \
            -s ${ARCHIVE_SCRATCH} \
            -u "true"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: reiiap-converted-pack
          path: |
            staging/target/packaged/geyser_resources.mcpack
            staging/target/packaged/geyser_addon.mcaddon
            staging/target/geyser_mappings.json
            staging/config.json


  post-result:
    name: üì¢ Post Result
    runs-on: ubuntu-latest
    needs: convert-pack
    permissions:
      issues: write

    steps:
      - name: Comment Success
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üöÄ Konversi Berhasil!

            File hasil convert bisa diunduh melalui halaman **GitHub Actions** berikut:

            üîó https://github.com/reiiap/javacvbedrock/actions/runs/${{ github.run_id }}

            ### üìÇ Cara Menggunakan:
            - Upload `geyser_resources.mcpack` ke folder `packs` milik Geyser.
            - Upload `geyser_mappings.json` ke folder `custom_mappings`.

            Jika ada kendala, silakan cek log pada halaman Actions.

            Issue ini akan ditutup otomatis.
          reactions: rocket

      - name: Close Issue
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}


  conversion-failed:
    name: ‚ùå Conversion Failed
    runs-on: ubuntu-latest
    needs: [get-pack-info, convert-pack]
    if: failure()
    permissions:
      issues: write

    steps:
      - name: Comment Failure
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ‚ùå Konversi Gagal

            Silakan cek detail error di halaman:

            üîó https://github.com/reiiap/javacvbedrock/actions/runs/${{ github.run_id }}

            Pastikan link resource pack valid dan dapat diakses publik.

            Jika merasa ini bug dari sistem, silakan buat laporan baru.
          reactions: confused

      - name: Close Issue
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}
